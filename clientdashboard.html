<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Uniquity Solutions - Client Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #96A3B1;
      --text: #1f2937;
      --muted: #4b5563;
      --card: #ffffff;
      --primary: #e94b4b;
      --primary-700: #d13f3f;
      --accent: #fbbf24;
      --ring: rgba(0,0,0,.08);
      --shadow: 0 10px 30px rgba(2,6,23,.15);
      --radius: 18px;
      --nav-h: 56px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }
    .nav { position: sticky; top: 0; z-index: 1100; background: rgba(0,0,0,.04); }
    main { padding: 20px; }
  </style>
</head>
<body>
  <!-- Minimal dashboard shell; replace with your real layout as needed -->
  <nav class="nav" aria-label="Main navigation">
    <div class="container" style="padding:10px 16px;">
      <strong>Uniquity Solutions</strong> - Dashboard
    </div>
  </nav>

  <main id="dashboard-content" aria-label="Dashboard">
    <!-- Your actual dashboard panels would render here -->
    <div style="padding:20px; background:#fff; border-radius:12px; border:1px solid #e5e7eb;">
      <h1 style="margin:0 0 8px;">Dashboard</h1>
      <p style="margin:0; color:#555;">Loading your data...</p>
    </div>
  </main>

  <!-- Supabase JS (deferred) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

  <script>
    // Replace with your actual values locally (keep these in env/config in prod)
    const SUPABASE_URL = 'https://gifguoyqccozlijrxgcf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZmd1b3lxY2NvemxpanJ4Z2NmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MTg2MzUsImV4cCI6MjA3MjE5NDYzNX0.gwZnr8fKE7qXuLi8B5Merul3cVAXZ1r6SaWEUoAJWX0';

    // Guard to prevent redirect loops
    let redirected = false;
    let sb;

    // Initialize Supabase client
    function initSupabase() {
      if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
        console.warn('Supabase not loaded yet. Will retry.');
        setTimeout(initSupabase, 100);
        return;
      }
      sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized on dashboard:', !!sb);
      ensureAuthAndRedirect();
    }

    // Wait for a valid session, then redirect to the appropriate dashboard
    async function ensureAuthAndRedirect() {
      if (redirected) return;

      try {
        // Retry logic to handle sign-in timing
        const MAX_RETRIES = 5;
        let user = null;
        for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
          const { data: { session } = {} } = await sb.auth.getSession();
          user = session?.user ?? null;
          if (user && user.id) break;
          await new Promise(res => setTimeout(res, 300));
        }

        // If still not authenticated, send to login
        if (!user || !user.id) {
          redirected = true;
          window.location.href = 'login.html';
          return;
        }

        // Optional: fetch role for RBAC routing
        let role = null;
        try {
          const { data: userRow } = await sb
            .from('users')
            .select('role')
            .eq('id', user.id)
            .maybeSingle();
          if (userRow?.role) role = userRow.role;
        } catch (e) {
          console.warn('Role fetch failed or table unavailable:', e);
        }

        // Target dashboard based on role
        const target = (role && String(role).toLowerCase() === 'admin')
          ? 'AdminDashboard.html'
          : 'clientdashboard.html';

        // Robust path check
        const currentPath = (window.location.pathname.split('/').pop() || '').toLowerCase();
        const normalizedTarget = target.toLowerCase();

        if (currentPath !== normalizedTarget) {
          redirected = true;
          window.location.href = target;
        } else {
          console.log('Already on the correct dashboard:', target);
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        // On error, be safe and redirect to client dashboard
        redirected = true;
        window.location.href = 'clientdashboard.html';
      }
    }

    // Kick off initialization after CDN loads
    setTimeout(initSupabase, 0);
  </script>

  <!-- Optional: placeholders or extra sections can be kept or removed as needed -->
  <script>
    // Example: load some placeholder payments (replace with real data)
    async function loadPayments() {
      const tbody = document.querySelector("#payments-table tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      const rows = [
        { id: "pay_1", client: "Client A", amount: "20.00", currency: "USD", status: "succeeded", date: "2025-01-01" }
      ];
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.id}</td><td>${r.client}</td><td>${r.amount}</td><td>${r.currency}</td><td>${r.status}</td><td>${r.date}</td>`;
        tbody.appendChild(tr);
      });
    }

    window.addEventListener('load', loadPayments);
  </script>
</body>
</html>
