<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Uniquity Solutions - Client Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #96A3B1;
      --text: #1f2937;
      --muted: #4b5563;
      --card: #ffffff;
      --primary: #e94b4b;
      --primary-700: #d13f3f;
      --accent: #fbbf24;
      --ring: rgba(0,0,0,.08);
      --shadow: 0 10px 30px rgba(2,6,23,.15);
      --radius: 18px;
      --nav-h: 56px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }
    .nav { position: sticky; top: 0; z-index: 1100; background: rgba(0,0,0,.04); }
    /* Minimal placeholder content styling to keep layout intact */
    main { padding: 20px; }
  </style>
</head>
<body>
  <!-- Minimal dashboard shell; real content goes here -->
  <nav class="nav" aria-label="Main navigation">
    <div class="container" style="padding:10px 16px;">
      <strong>Uniquity Solutions</strong> - Dashboard
    </div>
  </nav>

  <main id="dashboard-content" aria-label="Dashboard">
    <!-- Your actual dashboard panels would render here -->
    <div style="padding:20px; background:#fff; border-radius:12px; border:1px solid #e5e7eb;">
      <h1 style="margin:0 0 8px;">Dashboard</h1>
      <p style="margin:0; color:#555;">Loading your data...</p>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script>
    // Replace with your actual values locally
    const SUPABASE_URL = 'https://gifguoyqccozlijrxgcf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZmd1b3lxY2NvemxpanJ4Z2NmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MTg2MzUsImV4cCI6MjA3MjE5NDYzNX0.gwZnr8fKE7qXuLi8B5Merul3cVAXZ1r6SaWEUoAJWX0';

    // One-time guard to prevent redirect loops
    let redirected = false;

    // Initialize Supabase client
    let sb;
    function initSupabase(){
      if (typeof supabase === 'undefined' || typeof supabase.createClient !== 'function') {
        console.warn('Supabase not loaded yet. Will retry.');
        setTimeout(initSupabase, 100);
        return;
      }
      sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase initialized on dashboard:', !!sb);
      ensureAuthAndRedirect();
    }

    // Check auth and redirect appropriately
    async function ensureAuthAndRedirect(){
      if (redirected) return;

      try {
        // Try to get current session/user
        const { data: { session } = {} } = await sb.auth.getSession();
        const user = session?.user ?? null;

        // If no authenticated user, redirect to login
        if (!user || !user.id) {
          redirected = true;
          window.location.href = 'login.html';
          return;
        }

        // If you have role-based routing, fetch role (optional)
        let role = null;
        try {
          const { data: userRow } = await sb
            .from('users')
            .select('role')
            .eq('id', user.id)
            .maybeSingle();
          if (userRow?.role) role = userRow.role;
        } catch (e) {
          console.warn('Role fetch failed or table unavailable:', e);
          // If role fetch fails, default to client dashboard
        }

        // Decide target based on role
        const target = (role && String(role).toLowerCase() === 'admin')
          ? 'AdminDashboard.html'
          : 'clientdashboard.html';

        // If we are already at the correct dashboard, do nothing extra
        // Otherwise redirect
        const currentPath = window.location.pathname.split('/').pop();
        if (currentPath.toLowerCase() !== target.toLowerCase()) {
          redirected = true;
          window.location.href = target;
        } else {
          // Already on the right page; render content or proceed
          console.log('Already on the correct dashboard:', target);
        }
      } catch (err) {
        console.error('Auth check failed:', err);
        // In case of error, fail open to client dashboard
        redirected = true;
        window.location.href = 'clientdashboard.html';
      }
    }

    // Kick off initialization after CDN loads
    setTimeout(initSupabase, 0);
  </script>
</body>
</html>

            <div class="chip" style="margin-top:6px;" id="balance-chip">Available</div>
          </div>
          <div class="card">
            <div class="section-title" style="margin-bottom:6px;">Stripe Onboarding</div>
            <div id="onboard-status" style="font-weight:700;">Not started</div>
          </div>
        </div>
      </section>

      <section class="panel" id="paymentsPanel">
        <div class="section-title">Recent Payments</div>
        <table id="payments-table">
          <thead><tr><th>ID</th><th>Client</th><th>Amount</th><th>Currency</th><th>Status</th><th>Date</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="panel" id="onboardingPanel" style="display:block;">
        <div class="section-title">Onboarding</div>
        <div id="onboarding-content" style="margin-top:6px;">
          Stripe onboarding status and links will appear here once bound to your tenant.
        </div>
      </section>
    </main>
  </div>

  <script>
    // This page will read the current user from localStorage (token, user_id, tenant_id, role)
    const role = localStorage.getItem("role");
    const tenantId = localStorage.getItem("tenant_id");

    // Simple RBAC guard
    if (!tenantId) {
      window.location.href = "/index.html";
    }
    // If needed, guard based on roles (tenant-admin, tenant-user, staff)
    // You can fetch tenant-specific content here using Supabase or your backend

    // Example fetch placeholders (replace with real endpoints or Supabase calls)
    async function loadPayments() {
      // Replace with real data fetch: SUPABASE or your backend
      const tbody = document.querySelector("#payments-table tbody");
      tbody.innerHTML = ""; // clear
      // Dummy data for skeleton
      const rows = [
        { id: "pay_1", client: "Client A", amount: "20.00", currency: "USD", status: "succeeded", date: "2025-01-01" }
      ];
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.id}</td><td>${r.client}</td><td>${r.amount}</td><td>${r.currency}</td><td>${r.status}</td><td>${r.date}</td>`;
        tbody.appendChild(tr);
      });
    }

    window.addEventListener("load", loadPayments);

    // Stripe onboarding toggle wiring (persisted on tenant in backend in production)
    // You can read onboarding_complete from the tenant record via Supabase and update UI accordingly

    // Open Stripe Dashboard (if youâ€™re enabling Stripe onboarding from frontend)
    document.getElementById("openStripe").addEventListener("click", (e) => {
      e.preventDefault();
      window.open('https://dashboard.stripe.com/connect/accounts/CONNECTED_ACCOUNT_ID', '_blank');
    });
  </script>
</body>
</html>
